# NGINX Configuration for Botpress, Flowise, and n8n Services

# Upstream configurations for each service

# Botpress upstream
upstream botpress_server {
    server botpress:3000;  # Botpress service
}

# Flowise upstream
upstream flowise_server {
    server flowise:12312;  # Flowise service
}

# n8n upstream
upstream n8n_server {
    server n8n:5678;  # n8n service
}

# General NGINX settings
server_tokens off;  # Disable server tokens for security

# Main server block
server {
    listen 80;  # Listen on port 80 (HTTP)
    server_name demobot.hopto.org;  # Replace with your domain name in production

    # Prevent displaying Botpress in an iframe (Clickjacking protection)
    add_header X-Frame-Options SAMEORIGIN;

    # Prevent browsers from trying to guess the MIME type
    add_header X-Content-Type-Options nosniff;

    # Enable XSS protection in browsers
    add_header X-XSS-Protection "1; mode=block";

    # Set max file upload size
    client_max_body_size 20M;

    ##########################################################################
    # Botpress Configuration
    ##########################################################################

    # WebSocket support for Botpress
    location /socket.io/ {
        proxy_pass http://botpress_server/socket.io/;  # WebSockets
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }

    # Botpress application traffic
    location / {
        proxy_pass http://botpress_server;  # Forward everything else to Botpress
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    ##########################################################################
    # Flowise Configuration
    ##########################################################################

    # All requests starting with /flowise will be proxied to the Flowise server
    location /flowise/ {
        proxy_pass http://flowise_server/;  # Forward to Flowise
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    ##########################################################################
    # n8n Configuration
    ##########################################################################

    # All requests starting with /n8n will be proxied to the n8n server
    location /n8n/ {
        proxy_pass http://n8n_server/;  # Forward to n8n
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    ##########################################################################
    # Caching of Static Assets (for all services)
    ##########################################################################

    # Serve cached assets (like images, CSS, JS) directly
    location ~* \.(jpg|jpeg|png|gif|css|js|ico|woff|woff2|ttf|eot|svg)$ {
        expires 30d;
        access_log off;
        add_header Cache-Control "public";
    }
}
